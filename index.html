<script>
let armesData = [];
let classesSauvegardees = [];

// === Chargement des armes ===
async function chargerArmes() {
  try {
    console.log("Chargement du fichier armes.json...");
    const res = await fetch("./data/armes.json");
    if (!res.ok) throw new Error("Fichier JSON introuvable !");
    const data = await res.json();
    armesData = data.armes;
    console.log(`‚úÖ ${armesData.length} armes charg√©es.`);
    remplirTypesArmes();
  } catch (err) {
    console.error("Erreur :", err);
    alert("Impossible de charger le fichier armes.json !");
  }
}

// === Remplissage des types d‚Äôarmes ===
function remplirTypesArmes() {
  const typeSelect = document.getElementById("weaponType");
  const armeSelect = document.getElementById("weaponName");
  const types = [...new Set(armesData.map(a => a.categorie))];

  typeSelect.innerHTML = `<option value="">-- Choisir un type --</option>`;
  types.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    typeSelect.appendChild(opt);
  });

  typeSelect.addEventListener("change", () => {
    const armes = armesData.filter(a => a.categorie === typeSelect.value);
    remplirArmes(armes);
  });
}

// === Liste des armes selon la cat√©gorie ===
function remplirArmes(armes) {
  const armeSelect = document.getElementById("weaponName");
  armeSelect.innerHTML = `<option value="">-- Choisir une arme --</option>`;

  armes.forEach(a => {
    const opt = document.createElement("option");
    opt.value = a.nom;
    opt.textContent = a.nom;
    armeSelect.appendChild(opt);
  });

  armeSelect.addEventListener("change", () => afficherArme(armeSelect.value));
}

// === Affichage complet d'une arme ===
function afficherArme(nom) {
  const arme = armesData.find(a => a.nom === nom);
  if (!arme) return;
  afficherStats(arme);
  afficherAccessoires(arme);
}

// === Statistiques ===
function afficherStats(arme) {
  const statsDiv = document.getElementById("weaponStats");
  if (!arme.stats) return (statsDiv.innerHTML = "");
  statsDiv.innerHTML = `
    <h3 class="text-lg font-semibold mb-2 text-blue-400">${arme.nom}</h3>
    <p><strong>D√©g√¢ts :</strong> ${arme.stats.degats ?? "‚Äî"}</p>
    <p><strong>Pr√©cision :</strong> ${arme.stats.precision ?? "‚Äî"}</p>
    <p><strong>Contr√¥le :</strong> ${arme.stats.controle ?? "‚Äî"}</p>
    <p><strong>Mobilit√© :</strong> ${arme.stats.mobilite ?? "‚Äî"}</p>
  `;
}

// === Accessoires dynamiques ===
function afficherAccessoires(arme) {
  const container = document.getElementById("slots");
  container.innerHTML = "";

  if (!arme.accessoires) {
    container.innerHTML = "<p class='text-gray-400'>Aucun accessoire disponible pour cette arme.</p>";
    return;
  }

  Object.entries(arme.accessoires).forEach(([categorie, liste]) => {
    if (!Array.isArray(liste) || liste.length === 0) return;
    const div = document.createElement("div");
    div.className = "mb-3";

    const label = document.createElement("label");
    label.textContent = categorie.charAt(0).toUpperCase() + categorie.slice(1);
    label.className = "block text-sm mb-1 text-gray-300";

    const select = document.createElement("select");
    select.className = "w-full bg-slate-700 p-2 rounded";
    select.id = `slot-${categorie}`;

    liste.forEach(opt => {
      const option = document.createElement("option");
      option.value = opt;
      option.textContent = opt;
      select.appendChild(option);
    });

    div.appendChild(label);
    div.appendChild(select);
    container.appendChild(div);
  });
}

// === Sauvegarder une classe ===
document.getElementById("saveBtn").addEventListener("click", () => {
  const armeNom = document.getElementById("weaponName").value;
  const arme = armesData.find(a => a.nom === armeNom);
  if (!arme) return alert("Aucune arme s√©lectionn√©e !");

  const nomClasse = prompt("Donne un nom √† ta classe :", arme.nom);
  if (!nomClasse) return;

  const config = { nom: nomClasse, arme: arme.nom, accessoires: {} };
  Object.keys(arme.accessoires).forEach(cat => {
    const select = document.getElementById(`slot-${cat}`);
    if (select) config.accessoires[cat] = select.value;
  });

  classesSauvegardees.push(config);
  localStorage.setItem("classesBF6", JSON.stringify(classesSauvegardees));
  afficherClasses();
});

// === Afficher les classes sauvegard√©es ===
function afficherClasses() {
  const cards = document.getElementById("cards");
  cards.innerHTML = "";

  classesSauvegardees.forEach((classe, index) => {
    const div = document.createElement("div");
    div.className = "bg-slate-700 p-3 rounded-lg shadow-md flex flex-col gap-1";

    let accessoiresHTML = "";
    for (const [cat, val] of Object.entries(classe.accessoires)) {
      accessoiresHTML += `<p><strong>${cat} :</strong> ${val}</p>`;
    }

    div.innerHTML = `
      <input value="${classe.nom}" id="classe-nom-${index}" class="bg-slate-800 text-white p-1 rounded mb-1 w-full"/>
      <p><strong>Arme :</strong> ${classe.arme}</p>
      ${accessoiresHTML}
      <div class="flex gap-2 mt-2">
        <button class="bg-blue-600 px-2 py-1 rounded" onclick="chargerClasse(${index})">Modifier</button>
        <button class="bg-green-600 px-2 py-1 rounded" onclick="exporterClasse(${index})">Exporter</button>
        <button class="bg-red-600 px-2 py-1 rounded" onclick="supprimerClasse(${index})">Supprimer</button>
      </div>
    `;
    cards.appendChild(div);
  });
}

// === Charger une classe existante ===
function chargerClasse(index) {
  const classe = classesSauvegardees[index];
  if (!classe) return;

  const arme = armesData.find(a => a.nom === classe.arme);
  if (!arme) return alert("Arme introuvable dans le JSON !");

  document.getElementById("weaponType").value = arme.categorie;
  afficherArme(arme.nom);
  document.getElementById("weaponName").value = arme.nom;

  setTimeout(() => {
    Object.entries(classe.accessoires).forEach(([cat, val]) => {
      const select = document.getElementById(`slot-${cat}`);
      if (select) select.value = val;
    });
  }, 100);
}

// === Supprimer une classe ===
function supprimerClasse(index) {
  if (!confirm("Supprimer cette classe ?")) return;
  classesSauvegardees.splice(index, 1);
  localStorage.setItem("classesBF6", JSON.stringify(classesSauvegardees));
  afficherClasses();
}

// === Exporter toutes les classes ===
document.getElementById("exportBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(classesSauvegardees, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "classes_bf6.json";
  a.click();
  URL.revokeObjectURL(url);
});

// === Importer un fichier JSON ===
document.getElementById("importBtn").addEventListener("click", async () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json";
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    classesSauvegardees = JSON.parse(text);
    localStorage.setItem("classesBF6", JSON.stringify(classesSauvegardees));
    afficherClasses();
    alert("‚úÖ Classes import√©es !");
  };
  input.click();
});

// === Partager la configuration ===
document.getElementById("shareBtn").addEventListener("click", () => {
  const data = btoa(JSON.stringify(classesSauvegardees));
  const link = `${window.location.origin}${window.location.pathname}?data=${data}`;
  navigator.clipboard.writeText(link);
  alert("üîó Lien de partage copi√© !");
});

// === D√©connexion ===
document.getElementById("logoutBtn").addEventListener("click", () => {
  if (confirm("Se d√©connecter ? Toutes les donn√©es locales seront effac√©es.")) {
    localStorage.removeItem("classesBF6");
    classesSauvegardees = [];
    afficherClasses();
    alert("D√©connect√© !");
  }
});

// === Initialisation ===
window.addEventListener("load", () => {
  const saved = localStorage.getItem("classesBF6");
  if (saved) classesSauvegardees = JSON.parse(saved);
  afficherClasses();
  chargerArmes();
});
</script>
